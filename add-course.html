<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Course — UKVI INFO</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: Inter, system-ui, Arial;
      background: #f6f8fb;
      padding: 24px;
      color: #0d2438;
    }

    .card {
      max-width: 800px;
      margin: 24px auto;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    label {
      display: block;
      font-size: .9rem;
      margin-bottom: 6px;
      color: #475569;
    }

    input[type="text"],
    input[type="url"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #e6edf3;
      box-sizing: border-box;
    }

    .col {
      flex: 1 1 240px;
      min-width: 200px;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-primary {
      background: #1a365d;
      color: white;
    }

    .btn-secondary {
      background: #e6edf3;
      color: #0d2438;
    }

    .helper {
      font-size: .85rem;
      color: #64748b;
      margin-top: 6px;
    }

    .notice {
      margin-top: 12px;
      padding: 10px;
      border-radius: 6px;
      background: #ecfeff;
      color: #065f46;
      display: none;
    }

    a.home {
      color: #1a365d;
      text-decoration: none;
      font-size: .95rem;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
  </style>
</head>

<body>
  <div class="card">
    <a href="Index.html" class="home"><i class="fas fa-arrow-left"></i> Back to Courses</a>
    <h2>Add Course</h2>
    <p class="helper">Fill fields and click <strong>Save Course</strong>. This will save to Firestore (or locally as a
      fallback).</p>

    <form id="addCourseForm">
      <div class="row">
        <div class="col">
          <label for="university">University</label>
          <input id="university" name="university" type="text" placeholder="University name" required>
        </div>

        <div class="col">
          <label for="courseName">Course Name</label>
          <input id="courseName" name="courseName" type="text" placeholder="e.g. MSc Computer Science" required>
        </div>

        <div class="col">
          <label for="level">Level</label>
          <select id="level" name="level" required>
            <option value="postgraduate">Postgraduate</option>
            <option value="undergraduate">Undergraduate</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="col">
          <label for="intake">Intake</label>
          <input id="intake" name="intake" type="text" placeholder="e.g. April 2026" required>
        </div>

        <div class="col">
          <label for="campus">Campus/City</label>
          <input id="campus" name="campus" type="text" placeholder="City or campus" required>
        </div>

        <div class="col">
          <label for="duration">Duration</label>
          <input id="duration" name="duration" type="text" placeholder="e.g. 1 Year (Full-time)" required>
        </div>

        <div class="col">
          <label for="fee">Course Fee</label>
          <input id="fee" name="fee" type="text" placeholder="e.g. £15,150 per year" required>
        </div>

        <div class="col" style="flex-basis:100%;">
          <label for="officialLink">Official Link (optional)</label>
          <input id="officialLink" name="officialLink" type="url" placeholder="https://...">
        </div>
      </div>

      <div class="col" style="flex-basis:100%;">
        <label for="academicReq">Entry Requirements (short)</label>
        <textarea id="academicReq" name="academicReq" rows="2" placeholder="e.g. Bachelor's degree or equivalent"
          required></textarea>
      </div>

      <div class="col" style="flex-basis:100%;">
        <label for="description">Course Overview</label>
        <textarea id="description" name="description" rows="4" placeholder="Short course overview" required></textarea>
      </div>

      <div class="col" style="flex-basis:100%;">
        <label for="englishReq">English Requirements (comma separated)</label>
        <input id="englishReq" name="englishReq" type="text" placeholder="e.g. IELTS 6.0, No component below 5.5">
      </div>

      <div class="actions">
        <button type="submit" class="btn-primary">Save Course</button>
        <button type="button" id="clearBtn" class="btn-secondary">Clear</button>
      </div>

      <div id="notice" class="notice"></div>
    </form>
  </div>

  <!-- Firebase compat SDKs (namespaced) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config (same as Index.js)
    const firebaseConfig = {
      apiKey: "AIzaSyCGQKCkBDhozfG8bqYObKSCS2sxdZQEJm4",
      authDomain: "ukvi-info.firebaseapp.com",
      projectId: "ukvi-info",
      storageBucket: "ukvi-info.firebasestorage.app",
      messagingSenderId: "40936408296",
      appId: "1:40936408296:web:661bb619ed6bc75437355d",
      measurementId: "G-N021HN10HT"
    };

    // Initialize Firebase (compat) if present
    let db = null;
    if (window.firebase) {
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    } else {
      console.warn('Firebase SDK not loaded on add-course page.');
    }

    function showNotice(msg, ok = true) {
      const n = document.getElementById('notice');
      n.style.display = 'block';
      n.classList.toggle('error', !ok);
      n.textContent = msg;
      setTimeout(() => n.style.display = 'none', 3500);
    }

    function saveCourseToLocal(newCourse) {
      try {
        const raw = localStorage.getItem('customCourses');
        const arr = raw ? JSON.parse(raw) : [];
        arr.push(newCourse);
        localStorage.setItem('customCourses', JSON.stringify(arr));
        return true;
      } catch (err) {
        console.error('Local save failed', err);
        return false;
      }
    }

    document.getElementById('addCourseForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const u = document.getElementById('university').value.trim();
      const courseName = document.getElementById('courseName').value.trim();
      const level = document.getElementById('level').value.trim();
      const intake = document.getElementById('intake').value.trim();
      const campus = document.getElementById('campus').value.trim();
      const duration = document.getElementById('duration').value.trim();
      const fee = document.getElementById('fee').value.trim();
      const officialLink = document.getElementById('officialLink').value.trim();
      const academicReq = (document.getElementById('academicReq') || {}).value || '';
      const description = (document.getElementById('description') || {}).value || '';
      const englishReqInput = (document.getElementById('englishReq') || {}).value || '';

      if (!u || !courseName || !level || !intake || !campus || !duration || !fee || !academicReq || !description) {
        showNotice('Please fill in all required fields', false);
        return;
      }

      const englishReq = englishReqInput ? englishReqInput.split(',').map(s => s.trim()).filter(Boolean) : ['IELTS 6.0 or equivalent'];

      const newCourse = {
        id: Date.now() + Math.floor(Math.random() * 1000),
        university: u,
        courseName,
        level,
        intake,
        fee,
        duration,
        officialLink: officialLink || 'https://example.com',
        campus,
        academicReq,
        description,
        englishReq,
        createdAt: new Date().toISOString()
      };

      try {
        // Firestore
        if (db) {
          await db.collection('courses').doc(String(newCourse.id)).set(newCourse);
          showNotice('✓ Course saved to Firestore. Redirecting...');
          setTimeout(() => { window.location.href = 'Index.html'; }, 1000);
          return;
        }

        // Try parent/opener hooks (if any)
        if (window.opener && window.opener.saveCourseToCFirebase) {
          await window.opener.saveCourseToCFirebase(newCourse);
          showNotice('✓ Course added. Redirecting...');
          setTimeout(() => { window.location.href = 'Index.html'; }, 900);
          return;
        }
        if (window.parent && window.parent.saveCourseToCFirebase) {
          await window.parent.saveCourseToCFirebase(newCourse);
          showNotice('✓ Course added. Redirecting...');
          setTimeout(() => { window.location.href = 'Index.html'; }, 900);
          return;
        }

        // Local fallback
        if (saveCourseToLocal(newCourse)) {
          showNotice('✓ Course saved locally (fallback). Redirecting...');
          setTimeout(() => { window.location.href = 'Index.html'; }, 800);
          return;
        }

        showNotice('Could not save course', false);
      } catch (err) {
        console.error('Save failed:', err);
        showNotice('Error adding course: ' + (err.message || String(err)), false);
      }
    });

    document.getElementById('clearBtn').addEventListener('click', function () {
      document.getElementById('addCourseForm').reset();
    });
  </script>
</body>

</html>